# SURGE Platform - Integration Guide

## Panduan Teknis untuk Mengintegrasikan Device dan Sistem dengan SURGE

**Version**: 1.0 | **Last Updated**: December 28, 2025

---

# DAFTAR ISI

1. [Arsitektur Integrasi](#1-arsitektur-integrasi)
2. [Integrasi MQTT](#2-integrasi-mqtt)
3. [Integrasi Modbus via Gateway](#3-integrasi-modbus-via-gateway)
4. [REST API Integration](#4-rest-api-integration)
5. [Webhook Integration](#5-webhook-integration)
6. [Third-party Integrations](#6-third-party-integrations)
7. [Troubleshooting](#7-troubleshooting)

---

# 1. ARSITEKTUR INTEGRASI

## Overview

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                           SURGE INTEGRATION ARCHITECTURE                       │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                      │
│   │   Modbus    │    │    MQTT     │    │   REST API  │                      │
│   │   Sensors   │    │   Devices   │    │   Systems   │                      │
│   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                      │
│          │                  │                  │                              │
│          ▼                  │                  │                              │
│   ┌─────────────┐          │                  │                              │
│   │  SURIOTA    │          │                  │                              │
│   │  Gateway    │──────────┘                  │                              │
│   │SRT-MGATE-1210│                            │                              │
│   └──────┬──────┘                             │                              │
│          │                                    │                              │
│          ▼                                    ▼                              │
│   ┌─────────────────────────────────────────────────────────────────────┐    │
│   │                         SURGE PLATFORM                               │    │
│   │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    │    │
│   │  │MQTT Broker │  │ REST API   │  │ TimescaleDB│  │ Dashboard  │    │    │
│   │  │ (EMQX)     │  │ (NestJS)   │  │(PostgreSQL)│  │ (Next.js)  │    │    │
│   │  └────────────┘  └────────────┘  └────────────┘  └────────────┘    │    │
│   └─────────────────────────────────────────────────────────────────────┘    │
│          │                                    │                              │
│          ▼                                    ▼                              │
│   ┌─────────────┐                      ┌─────────────┐                      │
│   │  Webhooks   │                      │External Apps│                      │
│   │(Outbound)   │                      │(ERP/BI/etc) │                      │
│   └─────────────┘                      └─────────────┘                      │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## Supported Protocols

| Protocol | Direction | Use Case | Tier Required |
|----------|:---------:|----------|:-------------:|
| **MQTT** | Inbound | IoT device data ingestion | All |
| **REST API** | Both | System integration, data query | Business+ |
| **Webhook** | Outbound | Push events to external system | Business+ |
| **Modbus RTU** | Inbound | Via SURIOTA Gateway | All |
| **Modbus TCP** | Inbound | Via SURIOTA Gateway | All |

---

# 2. INTEGRASI MQTT

## 2.1 MQTT Broker Details

| Setting | Value |
|---------|-------|
| **Broker URL** | `mqtt.suriota.com` |
| **Port (MQTT)** | 1883 |
| **Port (MQTTS/TLS)** | 8883 |
| **WebSocket** | `wss://mqtt.suriota.com:8084/mqtt` |
| **Protocol** | MQTT v3.1.1 / v5.0 |
| **QoS Supported** | 0, 1, 2 |

---

## 2.2 Authentication

### Username/Password (Recommended)

Dapatkan credentials dari SURGE Dashboard:

1. Login ke SURGE
2. Navigasi ke **Settings > Devices**
3. Klik **Add Device**
4. Copy MQTT credentials

```
Username: <organization_id>_<device_id>
Password: <auto-generated-token>
```

### Client Certificate (Professional Tier)

Untuk security yang lebih tinggi, tersedia mutual TLS:

1. Request certificate dari support
2. Configure client dengan:
   - CA Certificate
   - Client Certificate
   - Client Key

---

## 2.3 Topic Structure

### Data Publishing (Device → SURGE)

**Topic Format:**
```
surge/<org_id>/<location_id>/<device_id>/telemetry
```

**Example:**
```
surge/org_abc123/loc_outlet1/dev_gateway01/telemetry
```

**Payload Format (JSON):**
```json
{
  "timestamp": "2025-12-28T08:30:00Z",
  "data": {
    "ph": 7.2,
    "cod": 85.5,
    "tss": 32.1,
    "flow": 25.3,
    "temperature": 28.5
  }
}
```

### Alternate Payload Format (Array)

```json
{
  "timestamp": "2025-12-28T08:30:00Z",
  "parameters": [
    {"name": "ph", "value": 7.2, "unit": ""},
    {"name": "cod", "value": 85.5, "unit": "mg/L"},
    {"name": "tss", "value": 32.1, "unit": "mg/L"}
  ]
}
```

---

## 2.4 Sample Code

### Arduino/ESP32

```cpp
#include <WiFi.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>

// WiFi credentials
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

// MQTT credentials (from SURGE Dashboard)
const char* mqtt_server = "mqtt.suriota.com";
const int mqtt_port = 8883;
const char* mqtt_user = "org_abc123_dev_gateway01";
const char* mqtt_pass = "your_mqtt_token";
const char* mqtt_topic = "surge/org_abc123/loc_outlet1/dev_gateway01/telemetry";

WiFiClientSecure espClient;
PubSubClient client(espClient);

void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  espClient.setInsecure(); // For testing only, use cert in production
  client.setServer(mqtt_server, mqtt_port);
}

void publishData(float ph, float cod, float tss) {
  StaticJsonDocument<256> doc;
  doc["timestamp"] = "2025-12-28T08:30:00Z";

  JsonObject data = doc.createNestedObject("data");
  data["ph"] = ph;
  data["cod"] = cod;
  data["tss"] = tss;

  char buffer[256];
  serializeJson(doc, buffer);

  client.publish(mqtt_topic, buffer);
}

void loop() {
  if (!client.connected()) {
    client.connect("ESP32Client", mqtt_user, mqtt_pass);
  }
  client.loop();

  // Read sensors and publish
  float ph = readPH();      // Your sensor reading function
  float cod = readCOD();
  float tss = readTSS();

  publishData(ph, cod, tss);

  delay(60000); // Publish every 60 seconds
}
```

### Python

```python
import paho.mqtt.client as mqtt
import json
from datetime import datetime
import ssl

# MQTT Configuration
MQTT_BROKER = "mqtt.suriota.com"
MQTT_PORT = 8883
MQTT_USER = "org_abc123_dev_gateway01"
MQTT_PASS = "your_mqtt_token"
MQTT_TOPIC = "surge/org_abc123/loc_outlet1/dev_gateway01/telemetry"

def on_connect(client, userdata, flags, rc):
    if rc == 0:
        print("Connected to SURGE MQTT Broker")
    else:
        print(f"Failed to connect, return code {rc}")

def publish_data(client, ph, cod, tss, flow):
    payload = {
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "data": {
            "ph": ph,
            "cod": cod,
            "tss": tss,
            "flow": flow
        }
    }

    client.publish(MQTT_TOPIC, json.dumps(payload))
    print(f"Published: {payload}")

# Create client
client = mqtt.Client()
client.username_pw_set(MQTT_USER, MQTT_PASS)
client.tls_set(cert_reqs=ssl.CERT_NONE)  # Use proper cert in production
client.on_connect = on_connect

# Connect and publish
client.connect(MQTT_BROKER, MQTT_PORT, 60)
client.loop_start()

# Example: Publish sensor data
publish_data(client, ph=7.2, cod=85.5, tss=32.1, flow=25.3)
```

### Node.js

```javascript
const mqtt = require('mqtt');

const options = {
  host: 'mqtt.suriota.com',
  port: 8883,
  protocol: 'mqtts',
  username: 'org_abc123_dev_gateway01',
  password: 'your_mqtt_token',
  rejectUnauthorized: false // Use proper cert in production
};

const client = mqtt.connect(options);

client.on('connect', () => {
  console.log('Connected to SURGE MQTT Broker');

  const topic = 'surge/org_abc123/loc_outlet1/dev_gateway01/telemetry';

  const payload = {
    timestamp: new Date().toISOString(),
    data: {
      ph: 7.2,
      cod: 85.5,
      tss: 32.1,
      flow: 25.3
    }
  };

  client.publish(topic, JSON.stringify(payload));
  console.log('Data published:', payload);
});

client.on('error', (err) => {
  console.error('Connection error:', err);
});
```

---

# 3. INTEGRASI MODBUS VIA GATEWAY

## 3.1 SURIOTA SRT-MGATE-1210

Gateway SRT-MGATE-1210 mengkonversi Modbus RTU/TCP ke MQTT secara otomatis.

### Spesifikasi

| Feature | Specification |
|---------|---------------|
| RS-485 Ports | 2 ports, isolated |
| Baud Rate | 9600 - 115200 |
| Modbus Mode | RTU & TCP |
| Output Protocol | MQTT + JSON |
| Configuration | BLE Mobile App |

---

## 3.2 Konfigurasi Gateway

### Step 1: Install SURIOTA Config App

1. Download dari Play Store / App Store
2. Search "SURIOTA Gateway Config"
3. Install dan buka

### Step 2: Connect ke Gateway via BLE

1. Power on gateway
2. Open app, scan for devices
3. Select "SRT-MGATE-XXXX"
4. Enter PIN: 123456 (default)

### Step 3: Configure Network

**WiFi Configuration:**
```
SSID: [Your WiFi SSID]
Password: [Your WiFi Password]
```

**Ethernet Configuration:**
- DHCP: Enabled (default)
- Or set static IP if needed

### Step 4: Configure MQTT

```
Broker: mqtt.suriota.com
Port: 8883
TLS: Enabled
Username: [From SURGE Dashboard]
Password: [From SURGE Dashboard]
Client ID: [Auto-generated]
Topic Prefix: surge/[org_id]/[location_id]/
```

### Step 5: Configure Modbus Slaves

**Example for pH Sensor:**
```
Slave Address: 1
Register: 0x0000
Function: 03 (Read Holding Registers)
Data Type: Float32
Parameter Name: ph
Polling Interval: 10 seconds
```

**Example for Multi-parameter:**
```
Slave 1 (pH):     Addr 1, Reg 0x0000, Float32
Slave 2 (COD):    Addr 2, Reg 0x0000, Float32
Slave 3 (TSS):    Addr 3, Reg 0x0000, Float32
Slave 4 (Flow):   Addr 4, Reg 0x0000, Float32
```

---

## 3.3 Common Modbus Configurations

### pH Meter (Generic)

| Setting | Value |
|---------|-------|
| Slave Address | 1 |
| Baud Rate | 9600 |
| Data Bits | 8 |
| Parity | None |
| Stop Bits | 1 |
| Register | 0x0000 |
| Data Type | Float32 (Big Endian) |

### Flow Meter (Electromagnetic)

| Setting | Value |
|---------|-------|
| Slave Address | 2 |
| Baud Rate | 9600 |
| Register (Flow Rate) | 0x0000 |
| Register (Totalizer) | 0x0002 |
| Data Type | Float32 |

### Energy Meter (Modbus)

| Setting | Value |
|---------|-------|
| Slave Address | 1 |
| Baud Rate | 9600 |
| Register (kWh) | 0x0000 |
| Register (kW) | 0x0002 |
| Register (V) | 0x0004 |
| Register (A) | 0x0006 |
| Data Type | Float32 |

---

# 4. REST API INTEGRATION

## 4.1 API Overview

| Endpoint Base | `https://api.suriota.com/v1` |
|---------------|------------------------------|
| Authentication | Bearer Token (JWT) |
| Format | JSON |
| Rate Limit | 100 requests/minute |

---

## 4.2 Authentication

### Get Access Token

```http
POST /auth/login
Content-Type: application/json

{
  "email": "your@email.com",
  "password": "your_password"
}
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
  "expires_in": 3600
}
```

### Using Token

```http
GET /api/v1/telemetry
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## 4.3 Common Endpoints

### Get Latest Telemetry

```http
GET /api/v1/telemetry/latest?device_id=dev_gateway01
Authorization: Bearer <token>
```

**Response:**
```json
{
  "device_id": "dev_gateway01",
  "timestamp": "2025-12-28T08:30:00Z",
  "data": {
    "ph": 7.2,
    "cod": 85.5,
    "tss": 32.1
  }
}
```

### Get Historical Data

```http
GET /api/v1/telemetry/history?device_id=dev_gateway01&start=2025-12-01&end=2025-12-28&interval=1h
Authorization: Bearer <token>
```

**Response:**
```json
{
  "device_id": "dev_gateway01",
  "interval": "1h",
  "data": [
    {"timestamp": "2025-12-28T00:00:00Z", "ph": 7.1, "cod": 82, "tss": 30},
    {"timestamp": "2025-12-28T01:00:00Z", "ph": 7.2, "cod": 85, "tss": 32},
    ...
  ]
}
```

### Get Alerts

```http
GET /api/v1/alerts?status=active&limit=50
Authorization: Bearer <token>
```

### Export Data

```http
POST /api/v1/export
Authorization: Bearer <token>
Content-Type: application/json

{
  "device_id": "dev_gateway01",
  "parameters": ["ph", "cod", "tss"],
  "start": "2025-12-01",
  "end": "2025-12-28",
  "format": "csv"
}
```

---

# 5. WEBHOOK INTEGRATION

## 5.1 Configure Webhooks

1. Login ke SURGE Dashboard
2. Navigasi ke **Settings > Integrations > Webhooks**
3. Klik **Add Webhook**
4. Configure:

| Setting | Example |
|---------|---------|
| URL | https://your-system.com/webhook/surge |
| Events | alert.triggered, data.received |
| Secret | your_webhook_secret |
| Headers | Authorization: Bearer xxx |

---

## 5.2 Webhook Events

### Alert Triggered

```json
{
  "event": "alert.triggered",
  "timestamp": "2025-12-28T08:30:00Z",
  "data": {
    "alert_id": "alert_123",
    "device_id": "dev_gateway01",
    "parameter": "ph",
    "value": 5.8,
    "threshold": 6.0,
    "severity": "critical",
    "message": "pH value 5.8 is below threshold 6.0"
  }
}
```

### Alert Resolved

```json
{
  "event": "alert.resolved",
  "timestamp": "2025-12-28T08:45:00Z",
  "data": {
    "alert_id": "alert_123",
    "device_id": "dev_gateway01",
    "parameter": "ph",
    "value": 7.2,
    "duration_minutes": 15
  }
}
```

### Device Offline

```json
{
  "event": "device.offline",
  "timestamp": "2025-12-28T09:00:00Z",
  "data": {
    "device_id": "dev_gateway01",
    "last_seen": "2025-12-28T08:55:00Z"
  }
}
```

---

## 5.3 Verifying Webhook Signature

SURGE signs webhooks with HMAC-SHA256:

```python
import hmac
import hashlib

def verify_signature(payload, signature, secret):
    expected = hmac.new(
        secret.encode(),
        payload.encode(),
        hashlib.sha256
    ).hexdigest()

    return hmac.compare_digest(signature, f"sha256={expected}")

# Usage
payload = request.body
signature = request.headers.get('X-Surge-Signature')
secret = "your_webhook_secret"

if verify_signature(payload, signature, secret):
    # Process webhook
    pass
```

---

# 6. THIRD-PARTY INTEGRATIONS

## 6.1 Power BI

### Setup

1. Open Power BI Desktop
2. Get Data → Web
3. Enter SURGE API URL with parameters
4. Add authentication header

### Sample Query

```
https://api.suriota.com/v1/telemetry/history?device_id=dev_gateway01&start=2025-12-01&end=2025-12-28&format=json
```

---

## 6.2 Grafana

### Add Data Source

1. Configuration → Data Sources
2. Add "JSON API" plugin
3. Configure:
   - URL: `https://api.suriota.com/v1`
   - Auth: Add Bearer token in headers

### Sample Dashboard Query

```json
{
  "path": "/telemetry/history",
  "params": {
    "device_id": "dev_gateway01",
    "start": "${__from:date:iso}",
    "end": "${__to:date:iso}"
  }
}
```

---

## 6.3 WhatsApp Alert (via Webhook)

### Using Third-party Service (e.g., Fonnte)

1. Register di fonnte.com
2. Get API token
3. Configure SURGE webhook ke:

```
URL: https://api.fonnte.com/send
Headers:
  Authorization: YOUR_FONNTE_TOKEN
```

4. Create middleware to transform payload:

```javascript
// Webhook handler
app.post('/surge-to-whatsapp', (req, res) => {
  const surgeEvent = req.body;

  if (surgeEvent.event === 'alert.triggered') {
    const message = `⚠️ ALERT SURGE
Parameter: ${surgeEvent.data.parameter}
Value: ${surgeEvent.data.value}
Time: ${surgeEvent.timestamp}`;

    // Send to WhatsApp via Fonnte
    fetch('https://api.fonnte.com/send', {
      method: 'POST',
      headers: {
        'Authorization': process.env.FONNTE_TOKEN,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        target: '628123456789',
        message: message
      })
    });
  }

  res.status(200).send('OK');
});
```

---

## 6.4 SAP/ERP Integration

### Integration Pattern

1. SURGE → Webhook → Middleware → SAP RFC/BAPI
2. Or: Scheduled job → SURGE API → Transform → SAP

### Sample Middleware

```python
from pyrfc import Connection

def send_to_sap(surge_data):
    conn = Connection(
        ashost='sap.company.com',
        sysnr='00',
        client='100',
        user='SAP_USER',
        passwd='SAP_PASS'
    )

    result = conn.call('Z_IOT_DATA_IMPORT', {
        'DEVICE_ID': surge_data['device_id'],
        'TIMESTAMP': surge_data['timestamp'],
        'PARAMETERS': [
            {'NAME': k, 'VALUE': v}
            for k, v in surge_data['data'].items()
        ]
    })

    return result
```

---

# 7. TROUBLESHOOTING

## Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| MQTT connection refused | Wrong credentials | Check username/password from SURGE |
| MQTT timeout | Firewall blocking | Allow port 8883 outbound |
| Data not appearing | Wrong topic | Verify topic structure |
| API 401 error | Token expired | Refresh token |
| Webhook not received | Wrong URL | Check URL reachable |
| Gateway offline | Network issue | Check WiFi/Ethernet |

---

## Debug Tools

### MQTT Debug

```bash
# Subscribe to all topics (for testing)
mosquitto_sub -h mqtt.suriota.com -p 8883 \
  -u "your_user" -P "your_pass" \
  --cafile ca.crt \
  -t "surge/#" -v
```

### API Debug

```bash
# Test API connection
curl -X GET "https://api.suriota.com/v1/health" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Webhook Debug

Use webhook.site or requestbin.com to test webhook payloads.

---

## Support Contact

| Issue Type | Contact |
|------------|---------|
| Integration questions | tech@suriota.com |
| API access | api@suriota.com |
| Gateway issues | support@suriota.com |
| WhatsApp | +62 858-3567-2476 |

---

_Document Version: 1.0_
_For Technical Teams_
_Last Updated: December 28, 2025_
